function onset_ic(subj, doraw, doz, doioz, onsetmode, srate, ...
                  halfwindow_s, usenotch)

if ~exist('doraw', 'var')
    doraw = 1;
end

if ~exist('doz', 'var')
    doz = 1;
end

if ~exist('doioz', 'var')
    doioz = 1;
end

if ~exist('onsetmode', 'var')
    onsetmode = 1;
end

if ~exist('srate', 'var')
    srate = 250;
end

if ~exist('halfwindow_s', 'var')
    halfwindow_s = 10;
end

if ~exist('usenotch', 'var')
    usenotch = 0;
end

prefix = fullfile('/Users/aaron/Documents/brainstorm_db/IEEG_Visualization/data', ...
                  subj, [subj '_']);

switch subj
  case 'UCHGG'
    onset_sz = {'25_08_23__21_20_17/timefreq_connect1_cohere_241010_1821.mat' ...
                '26_08_23__10_48_33/timefreq_connect1_cohere_241010_1826.mat' ...
                '26_08_23__14_25_10/timefreq_connect1_cohere_241010_1831.mat' ...
                '26_08_23__17_39_05/timefreq_connect1_cohere_241010_1836.mat' ...
                '27_08_23__10_54_38/timefreq_connect1_cohere_241010_1839.mat' ...
                '27_08_23__16_28_57/timefreq_connect1_cohere_241010_1843.mat' ...
                '28_08_23__03_25_43/timefreq_connect1_cohere_241010_1845.mat' ...
                '28_08_23__10_53_25/timefreq_connect1_cohere_241010_1848.mat' ...
                '28_08_23__14_43_42/timefreq_connect1_cohere_241010_1851.mat' ...
                '28_08_23__16_28_59/timefreq_connect1_cohere_241010_1854.mat' ...
                '28_08_23__16_51_19/timefreq_connect1_cohere_241010_2007.mat' ...
                '28_08_23__20_01_37/timefreq_connect1_cohere_241010_1900.mat' ...
                '29_08_23__05_42_28/timefreq_connect1_cohere_241010_1903.mat' ...
                '29_08_23__11_03_18/timefreq_connect1_cohere_241010_1905.mat' ...
                '29_08_23__16_01_13/timefreq_connect1_cohere_241010_1908.mat' ...
                '29_08_23__19_22_41/timefreq_connect1_cohere_241010_1911.mat'};

    onset_sz_filtered = {'25_08_23__21_20_17/timefreq_connect1_cohere_241020_0957.mat' ...
                        '26_08_23__10_48_33/timefreq_connect1_cohere_241020_0959.mat' ...
                        '26_08_23__14_25_10/timefreq_connect1_cohere_241020_1003.mat' ...
                        '26_08_23__17_39_05/timefreq_connect1_cohere_241020_1004.mat' ...
                        '27_08_23__10_54_38/timefreq_connect1_cohere_241020_1005.mat' ...
                        '27_08_23__16_28_57/timefreq_connect1_cohere_241020_1008.mat' ...
                        '28_08_23__03_25_43/timefreq_connect1_cohere_241020_1009.mat' ...
                        '28_08_23__10_53_25/timefreq_connect1_cohere_241020_1010.mat' ...
                        '28_08_23__14_43_42/timefreq_connect1_cohere_241020_1012.mat' ...
                        '28_08_23__16_28_59/timefreq_connect1_cohere_241020_1014.mat' ...
                        '28_08_23__16_51_19/timefreq_connect1_cohere_241020_1016.mat' ...
                        '28_08_23__20_01_37/timefreq_connect1_cohere_241020_1018.mat' ...
                        '29_08_23__05_42_28/timefreq_connect1_cohere_241020_1019.mat' ...
                        '29_08_23__11_03_18/timefreq_connect1_cohere_241020_1020.mat' ...
                        '29_08_23__16_01_13/timefreq_connect1_cohere_241020_1022.mat' ...
                        '29_08_23__19_22_41/timefreq_connect1_cohere_241020_1023.mat'};

    onset_times = [83 83.9 86.4 82.5 69.6 69.6 83.8 69.9 93.6 83.7 83.7 ...
                   72 68.4 83.1 70.3 76.5];

    offset_sz = {'25_08_23__21_20_17/timefreq_connect1_cohere_241010_1820.mat' ...
                 '26_08_23__10_48_33/timefreq_connect1_cohere_241010_1827.mat' ...
                 '26_08_23__14_25_10/timefreq_connect1_cohere_241010_1832.mat' ...
                 '26_08_23__17_39_05/timefreq_connect1_cohere_241010_1837.mat' ...
                 '27_08_23__10_54_38/timefreq_connect1_cohere_241010_1840.mat' ...
                 '27_08_23__16_28_57/timefreq_connect1_cohere_241010_1844.mat' ...
                 '28_08_23__03_25_43/timefreq_connect1_cohere_241010_1846.mat' ...
                 '28_08_23__10_53_25/timefreq_connect1_cohere_241010_1849.mat' ...
                 '28_08_23__14_43_42/timefreq_connect1_cohere_241010_1852.mat' ...
                 '28_08_23__16_28_59/timefreq_connect1_cohere_241010_1855.mat' ...
                 '28_08_23__16_51_19/timefreq_connect1_cohere_241010_2008.mat' ...
                 '28_08_23__20_01_37/timefreq_connect1_cohere_241010_1901.mat' ...
                 '29_08_23__05_42_28/timefreq_connect1_cohere_241010_1904.mat' ...
                 '29_08_23__11_03_18/timefreq_connect1_cohere_241010_1906.mat' ...
                 '29_08_23__16_01_13/timefreq_connect1_cohere_241010_1909.mat' ...
                 '29_08_23__19_22_41/timefreq_connect1_cohere_241010_1912.mat'};

    offset_times = [180 190.2 110.8 108 180 171 214.8 151.6 383 ...
                    112 130 130 123.9 185.1 175.2 194.9]; % first 130 probably not right

    ioz = {'RAH1', 'RAH2', 'RAH3', 'RPH1', 'RPH2', 'RPH3'};
    seedstr = 'RPI1';
  case 'UCHVG'
    onset_sz = {'25_07_23__03_33_09/timefreq_connect1_cohere_241021_1530.mat' ...
                '25_07_23__05_04_19/timefreq_connect1_cohere_241021_1537.mat' ...
                '25_07_23__06_19_48/timefreq_connect1_cohere_241021_1540.mat'};

    onset_times = [83.4 82.3 82.6];

    offset_sz = {'25_07_23__03_33_09/timefreq_connect1_cohere_241011_1941.mat' ...
                 '25_07_23__05_04_19/timefreq_connect1_cohere_241011_1939.mat' ...
                 '25_07_23__06_19_48/timefreq_connect1_cohere_241011_2031.mat'};

    offset_times = [171 179 172.9];

    ioz = {'LAH1', 'LAH2', 'LAH3', 'LAH4', 'LPH1', 'LPH2', 'LPH3', 'LPH4'};
    seedstr = 'LANT1';
  case 'UCHSN'
    onset_sz_filtered = {'10_04_23__12_38_07/timefreq_connect1_cohere_241022_1508.mat' ...
                        '10_04_23__18_58_17/timefreq_connect1_cohere_241022_1509.mat' ...
                        '11_04_23__07_54_50/timefreq_connect1_cohere_241022_1510.mat' ...
                        '11_04_23__08_44_42/timefreq_connect1_cohere_241022_1511.mat' ...
                        '11_04_23__09_30_50/timefreq_connect1_cohere_241022_1512.mat' ...
                        '12_04_23__11_23_41/timefreq_connect1_cohere_241022_1515.mat' ...
                        '12_04_23__17_08_19/timefreq_connect1_cohere_241022_1524.mat' ...
                        '12_04_23__17_44_02/timefreq_connect1_cohere_241022_1531.mat' ...
                        '13_04_23__08_22_24/timefreq_connect1_cohere_241022_1559.mat' ...
                        '13_04_23__08_35_40/timefreq_connect1_cohere_241022_1605.mat' ...
                        '13_04_23__09_00_33/timefreq_connect1_cohere_241022_1611.mat' ...
                        '13_04_23__09_31_42/timefreq_connect1_cohere_241022_1621.mat' ...
                        };

    onset_times = [97.6 84.4 97.9 79 66.4 82.1 81 102.6 60.6 91.2 ...
                   105.4 70.4 ];

    ioz = {'LPT5', 'LPT6', 'LPT7', 'LPT8'};
    seedstr = 'LCM2';
  case 'UCHDR'
    onset_sz = {'02_08_22__13_02_47/timefreq_connect1_cohere_241027_1908.mat' ...
                '02_08_22__13_38_36/timefreq_connect1_cohere_241028_2024.mat' ...
                '02_08_22__13_41_01/timefreq_connect1_cohere_241028_2025.mat' ...
                '02_08_22__13_43_37/timefreq_connect1_cohere_241028_2027.mat' ...
                '02_08_22__13_45_44/timefreq_connect1_cohere_241028_2028.mat' ...
                '02_08_22__13_47_15/timefreq_connect1_cohere_241028_2029.mat' ...
                '02_08_22__13_50_04/timefreq_connect1_cohere_241028_2030.mat' ...
                '02_08_22__13_52_22/timefreq_connect1_cohere_241028_2030.mat' ...
                '02_08_22__13_53_55/timefreq_connect1_cohere_241028_2032.mat' ...
                '02_08_22__13_56_06/timefreq_connect1_cohere_241028_2033.mat' ...
                '02_08_22__13_57_59/timefreq_connect1_cohere_241028_2034.mat' ...
                '02_08_22__14_00_35/timefreq_connect1_cohere_241028_2035.mat' ...
                '02_08_22__14_02_08/timefreq_connect1_cohere_241028_2039.mat' ...
    % '03_08_22__19_04_26/timefreq_connect1_cohere_241028_1914.mat' ...
               };

    onset_sz_filtered = {'02_08_22__13_02_47/timefreq_connect1_cohere_241028_2051.mat' ...
                        '02_08_22__13_38_36/timefreq_connect1_cohere_241028_2053.mat' ...
                        '02_08_22__13_41_01/timefreq_connect1_cohere_241028_2054.mat' ...
                        '02_08_22__13_43_37/timefreq_connect1_cohere_241028_2055.mat' ...
                        '02_08_22__13_45_44/timefreq_connect1_cohere_241028_2056.mat' ...
                        '02_08_22__13_47_15/timefreq_connect1_cohere_241028_2057.mat' ...
                        '02_08_22__13_50_04/timefreq_connect1_cohere_241028_2058.mat' ...
                        '02_08_22__13_52_22/timefreq_connect1_cohere_241028_2100.mat' ...
                        '02_08_22__13_53_55/timefreq_connect1_cohere_241028_2102.mat' ...
                        '02_08_22__13_56_06/timefreq_connect1_cohere_241028_2103.mat' ...
                        '02_08_22__13_57_59/timefreq_connect1_cohere_241028_2105.mat' ...
                        '02_08_22__14_00_35/timefreq_connect1_cohere_241028_2106.mat' ...
                        '02_08_22__14_02_08/timefreq_connect1_cohere_241028_2107.mat' ...
                        };

    onset_times = [46.8 53.4 47.9 46.5 47.6 46.8 47.3 47 47.2 45.5 ...
                   44.9 46.8 47.5];

    ioz = {'MEGA6', 'MEGA7'};
    seedstr = 'LANT1';
  case 'UCHCV220919'
    %    onset_sz_R = { };

    onset_sz_R_filtered = {'20_09_22__11_07_37/timefreq_connect1_cohere_241110_1202.mat' ...
                        };

    onset_times_R = [ ];

    ioz_R = {'RTO1' 'RTO2' 'RTO3' 'RTO4' 'RTO5' 'RTO6' 'RMSO5' 'RMSO6' 'RMSO7' ...
             'RMSO8' 'RMSO9'};
    seedstr_R = 'RPUL1';

    onset_sz_L_filtered = {'21_09_22__01_12_19/timefreq_connect1_cohere_241110_1215.mat' ...
                        '21_09_22__02_22_43/timefreq_connect1_cohere_241110_1220.mat' ...
                        '21_09_22__05_33_34/timefreq_connect1_cohere_241110_1232.mat' ...
                        '21_09_22__18_20_52/timefreq_connect1_cohere_241110_1301.mat' ...
                        '23_09_22__04_10_35/timefreq_connect1_cohere_241110_1519.mat' ...
                        '24_09_22__05_44_44/timefreq_connect1_cohere_241110_1538.mat' ...
                        '24_09_22__16_49_27/timefreq_connect1_cohere_241110_1549.mat' ...
                        '25_09_22__02_50_31/timefreq_connect1_cohere_241110_1556.mat' ...
                        '25_09_22__03_48_37/timefreq_connect1_cohere_241110_1602.mat' ...
                        '25_09_22__03_59_14/timefreq_connect1_cohere_241110_1619.mat' ...
                   };

    onset_times_L = [80.8 71.096 75.46 78.73 82.39 82.24 89.63 78.24 ...
                     64.54 80.33];

    ioz_L_small = {'LTO1' 'LTO2' 'LTO3' 'LTO4'};
    ioz_L_big = {ioz_L_small{:} 'LTO5' 'LTO6' 'LTO7' 'LTO8' 'LTO9' 'LTO10' ...
                 'LMIO6' 'LMIO7' 'LMIO8' 'LMIO9' 'LMIO10' 'LMIO11' ...
                 'LMI12' 'LMI13'};
    seedstr_L = 'LPUL1';

    onset_sz_filtered = onset_sz_L_filtered;
    onset_times = onset_times_L;
    ioz = ioz_L_small;
    seedstr = seedstr_L;
  case 'UCHSM240205'
    % onset_sz = {'02_08_22__13_02_47/timefreq_connect1_cohere_241027_1908.mat' ...
    %             '02_08_22__13_38_36/timefreq_connect1_cohere_241028_2024.mat' ...
    %             '02_08_22__13_41_01/timefreq_connect1_cohere_241028_2025.mat' ...
    %             '02_08_22__13_43_37/timefreq_connect1_cohere_241028_2027.mat' ...
    %             '02_08_22__13_45_44/timefreq_connect1_cohere_241028_2028.mat' ...
    %             '02_08_22__13_47_15/timefreq_connect1_cohere_241028_2029.mat' ...
    %             '02_08_22__13_50_04/timefreq_connect1_cohere_241028_2030.mat' ...
    %             '02_08_22__13_52_22/timefreq_connect1_cohere_241028_2030.mat' ...
    %             '02_08_22__13_53_55/timefreq_connect1_cohere_241028_2032.mat' ...
    %             '02_08_22__13_56_06/timefreq_connect1_cohere_241028_2033.mat' ...
    %             '02_08_22__13_57_59/timefreq_connect1_cohere_241028_2034.mat' ...
    %             '02_08_22__14_00_35/timefreq_connect1_cohere_241028_2035.mat' ...
    %             '02_08_22__14_02_08/timefreq_connect1_cohere_241028_2039.mat' ...
    % '03_08_22__19_04_26/timefreq_connect1_cohere_241028_1914.mat' ...
    %            };

    onset_sz_filtered = {'06_02_24__19_11_17/timefreq_connect1_cohere_241113_1856.mat' ...
                        '07_02_24__00_16_31/timefreq_connect1_cohere_241113_1909.mat' ...
                        '07_02_24__13_33_37/timefreq_connect1_cohere_241113_1916.mat' ...
                        '08_02_24__06_08_29/timefreq_connect1_cohere_241113_1924.mat' ...
                        '09_02_24__09_21_23/timefreq_connect1_cohere_241113_1930.mat' ...
                        '10_02_24__08_31_37/timefreq_connect1_cohere_241113_1936.mat' ...
                        '10_02_24__12_20_50/timefreq_connect1_cohere_241113_1943.mat' ...
                        '10_02_24__14_19_51/timefreq_connect1_cohere_241113_1949.mat' ...
                        };

    onset_times = [52.53 58.96 62.24 60.58 66.14 67.97 60.14 60.99];

    ioz = {'LAH1' 'LAH2' 'LAH3' 'LAH4' 'LAH5' ...
           'LPH1' 'LPH2' 'LPH3' 'LPH4' 'LPH5' ...
           'LBT1' 'LBT2' 'LBT3' ...
           'LAMY1' 'LAMY2' 'LAMY3' 'LAMY4'};
    seedstr = 'LPI1';
  case 'UCHAK'
    onset_sz_p1 = {'06_04_24__09_39_50/timefreq_connect1_cohere_241012_1018.mat' ...
               };

    offset_sz_p1 = {'06_04_24__09_39_50/timefreq_connect1_cohere_241012_1019.mat' ...
                };

end

if onsetmode
    if usenotch
        allsz = onset_sz_filtered;
    else
        allsz = onset_sz;
    end
    t = onset_times;
    figsubdir = 'IC_mean_tfs_onset';
else
    allsz = offset_sz;
    t = offset_times;
    figsubdir = 'IC_mean_tfs_offset';
end

figsdir = fullfile('analyses', subj, 'figs', figsubdir);

load([prefix allsz{1}]);
elecs = size(TF,1);
freqs = size(TF,3);
timepts = size(TF,2);

timevec = (-srate*halfwindow_s:(srate*halfwindow_s + 1))./srate;

allvals = nan(elecs, length(allsz), freqs, srate*2*halfwindow_s + 1);
meanvals = nan(elecs, freqs, srate*2*halfwindow_s + 1);
zvals = nan(size(meanvals));
iozzvals = nan(size(meanvals));
noniozzvals = nan(size(meanvals));
baselinevals = nan(elecs, length(allsz), freqs, srate*halfwindow_s);
baselinemeans = nan(elecs, freqs, srate*halfwindow_s);
zscore_clim = [-3 3];

skipthese = get_skip();

for i=1:length(allsz)
    % for every sz
    load([prefix allsz{i}]);
    
    % select 20 sec around onset time
    onset_sample = min(find(Time >= t(i)));
    selected_interval = TF(:, onset_sample-srate*halfwindow_s:onset_sample+srate*halfwindow_s, :);

    % for every elec, get tfs centered at onset
    for j=1:elecs
        allvals(j,i,:,:) = squeeze(selected_interval(j,:,:))';
        baselinevals(j,i,:,:) = squeeze(selected_interval(j,1:srate*halfwindow_s,:))';
    end
end

badinds = get_matching_inds(RowNames, skipthese);
goodinds = setdiff(1:elecs, badinds);

iozinds = get_matching_inds(RowNames, ioz);
noniozinds = setdiff(1:elecs, iozinds);

for i=1:elecs
    if length(find(badinds==i))>0
        continue
    else
        meanvals(i,:,:) = squeeze(mean(allvals(i,:,:,:), "omitnan"));
        baselinemeans(i,:,:) = squeeze(mean(baselinevals(i,:,:,:), "omitnan"));
        zvals(i,:,:) = do_zscore(squeeze(meanvals(i,:,:)), squeeze(baselinemeans(i,:,:)));
    end
end

iozmeanvals = meanvals(iozinds,:,:);
iozbaselinemeans = baselinemeans(iozinds,:,:);
iozzscore = do_zscore(squeeze(mean(iozmeanvals)), squeeze(mean(iozbaselinemeans)));
noniozmeanvals = meanvals(noniozinds,:,:);
noniozbaselinemeans = baselinemeans(noniozinds,:,:);
noniozzscore = do_zscore(squeeze(mean(noniozmeanvals, "omitnan")), ...
                         squeeze(mean(noniozbaselinemeans, "omitnan")));

if ~exist(figsdir, 'dir')
    mkdir(figsdir);
end

for i=1:length(RowNames)
    if any(strcmp(RowNames{i}, skipthese))
        continue;
    else
        if doraw
            % raw plot
            h = figure('visible', 'off');
            thismat = squeeze(meanvals(i,:,:));
            imagesc(thismat); axis xy; clim([0 1]);
            colorbar;        
            xticklabels(timevec(501:500:end));
            yticklabels(Freqs(5:5:end));
            xlabel('Time (s)');
            ylabel('Frequency (Hz)');
            title([seedstr '-' RowNames{i} ' IC']);
            print('-dpng', fullfile(figsdir, [seedstr '_' RowNames{i}]));
            close(h);
        end
        
        if doz
            % zscore
            h = figure('visible', 'off');
            thismat = squeeze(zvals(i,:,:));
            imagesc(thismat); axis xy; clim(zscore_clim);
            colorbar;        
            xticklabels(timevec(501:500:end));
            yticklabels(Freqs(5:5:end));
            xlabel('Time (s)');
            ylabel('Frequency (Hz)');
            title([seedstr '-' RowNames{i} ' z(IC)']);
            print('-dpng', fullfile(figsdir, [seedstr '_' RowNames{i} '_zscore']));
            close(h);
        end
    end
end

if doioz
    h = figure('visible', 'off');
    thismat = squeeze(mean(iozmeanvals, "omitnan"));
    imagesc(thismat); axis xy; clim([0 1]);
    colorbar;
    xticklabels(timevec(501:500:end));
    yticklabels(Freqs(5:5:end));
    xlabel('Time (s)');
    ylabel('Frequency (Hz)');
    title([seedstr '-IOZ mean IC']);
    print('-dpng', fullfile(figsdir, [seedstr '_ioz']));
    close(h);

    h = figure('visible', 'off');
    imagesc(iozzscore); axis xy; clim([-3 3]);
    colorbar;
    xticklabels(timevec(501:500:end));
    yticklabels(Freqs(5:5:end));
    xlabel('Time (s)');
    ylabel('Frequency (Hz)');
    title([seedstr '-IOZ mean z(IC)']);
    print('-dpng', fullfile(figsdir, [seedstr '_ioz_zscore']));
    close(h);

    h = figure('visible', 'off');
    thismat = squeeze(mean(noniozmeanvals, "omitnan"));
    imagesc(thismat); axis xy; clim([0 1]);
    colorbar;
    xticklabels(timevec(501:500:end));
    yticklabels(Freqs(5:5:end));
    xlabel('Time (s)');
    ylabel('Frequency (Hz)');
    title([seedstr '-nonIOZ mean IC']);
    print('-dpng', fullfile(figsdir, [seedstr '_nonioz']));
    close(h);

    h = figure('visible', 'off');
    imagesc(noniozzscore); axis xy; clim([-3 3]);
    colorbar;
    xticklabels(timevec(501:500:end));
    yticklabels(Freqs(5:5:end));
    xlabel('Time (s)');
    ylabel('Frequency (Hz)');
    title([seedstr '-nonIOZ mean z(IC)']);
    print('-dpng', fullfile(figsdir, [seedstr '_nonioz_zscore']));
    close(h);
end

system(['python make_ic_pdf.py ' subj ' ' figsubdir]);
